# This workflow automatically updates the version field in manifest.json
# when a new release tag is pushed to the repository.
#
# Workflow:
# 1. Triggers on any tag push matching the pattern 'v*' (e.g., v1.0.0, v0.3.1b3)
# 2. Extracts the version from the tag by removing the 'v' prefix
# 3. Checks out the repository's default branch (e.g., main)
# 4. Updates the version field in custom_components/veeam_br/manifest.json
# 5. Commits and pushes the change back to the default branch
#
# Note: This workflow always commits to the default branch, regardless of where
# the tag originated. Best practice is to create release tags from the default
# branch to ensure consistency.
#
# Example:
# - Tag pushed: v1.2.3
# - manifest.json version updated to: 1.2.3

name: Update Version

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  update-manifest:
    name: Update manifest.json version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG_NAME"

      - name: Update manifest.json
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Update version in manifest.json using Python with env variables
          python3 -c "
          import json
          import os
          import sys
          
          manifest_path = 'custom_components/veeam_br/manifest.json'
          version = os.environ.get('VERSION', '')
          
          if not version:
              print('Error: VERSION environment variable not set')
              sys.exit(1)
          
          try:
              with open(manifest_path, 'r') as f:
                  manifest = json.load(f)
              
              old_version = manifest.get('version', 'unknown')
              manifest['version'] = version
              
              with open(manifest_path, 'w') as f:
                  json.dump(manifest, f, indent=2)
                  f.write('\n')
              
              print(f'✓ Updated manifest.json version from {old_version} to {version}')
          except Exception as e:
              print(f'Error updating manifest.json: {e}')
              sys.exit(1)
          "

      - name: Commit and push changes
        env:
          VERSION: ${{ steps.version.outputs.version }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet custom_components/veeam_br/manifest.json; then
            echo "No changes to manifest.json"
          else
            git add custom_components/veeam_br/manifest.json
            git commit -m "chore: update manifest.json version to ${VERSION}"
            git push origin "${DEFAULT_BRANCH}"
            echo "✓ Committed and pushed manifest.json update"
          fi
